{% extends 'layout/base.html' %}

{% block extra_css %}
<link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
  <h2>Manage Flights</h2>
  
  <form method="GET" action="{{ url_for('manager.manage_flights') }}" class="filter-form">
      <div class="filter-group">
          <label>Status</label>
          <select name="status" class="filter-control">
              <option value="">All</option>
              <option value="Active" {% if request.args.get('status') == 'Active' %}selected{% endif %}>Active</option>
              <option value="Fully Booked" {% if request.args.get('status') == 'Fully Booked' %}selected{% endif %}>Fully Booked</option>
              <option value="Canceled" {% if request.args.get('status') == 'Canceled' %}selected{% endif %}>Canceled</option>
              <option value="Completed" {% if request.args.get('status') == 'Completed' %}selected{% endif %}>Completed</option>
          </select>
      </div>
      <div class="filter-group">
          <label>Source</label>
          <select name="source_id" class="filter-control">
              <option value="">All</option>
              {% for airport in airports %}
              <option value="{{ airport.airport_id }}" {% if request.args.get('source_id')|int == airport.airport_id %}selected{% endif %}>{{ airport.airport_name }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="filter-group">
          <label>Destination</label>
          <select name="dest_id" class="filter-control">
              <option value="">All</option>
              {% for airport in airports %}
              <option value="{{ airport.airport_id }}" {% if request.args.get('dest_id')|int == airport.airport_id %}selected{% endif %}>{{ airport.airport_name }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="filter-group">
          <label>From Date</label>
          <input type="date" name="date_from" class="filter-control" value="{{ request.args.get('date_from', '') }}">
      </div>
      <div class="filter-group">
          <label>To Date</label>
          <input type="date" name="date_to" class="filter-control" value="{{ request.args.get('date_to', '') }}">
      </div>
      <div class="filter-actions">
          <button type="submit" class="btn">Filter</button>
          <a href="{{ url_for('manager.manage_flights') }}" class="btn btn-secondary">Clear</a>
      </div>
  </form>

  <div class="card table-card">
    <div id="flightsTable"></div>
    {% if not flights %}
    <div style="text-align: center; padding: 3rem;">
      <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">✈</div>
      <p style="font-size: 1.1rem; color: var(--color-text-light); margin-bottom: 0.5rem;"><strong>No flights found</strong></p>
      <p style="color: var(--color-text-light);">No flights match your filters. Try <a href="{{ url_for('manager.manage_flights') }}" style="color: var(--color-primary); text-decoration: underline;">clearing filters</a> or <a href="{{ url_for('manager.add_flight') }}" style="color: var(--color-primary); text-decoration: underline;">add a new flight</a>.</p>
    </div>
    {% endif %}
  </div>
  <div class="back-link-container">
    <a
      href="{{ url_for('manager.manager_dashboard') }}"
      class="btn btn-secondary"
      >Back to Dashboard</a
    >
  </div>
</div>

<!-- The Modal -->
<div id="flightModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
        <h3>Flight Details</h3>
        <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body">
        <div id="loadingMessage">Loading details...</div>
        <div id="flightContent" style="display: none">
            <!-- Content will be injected here -->
        </div>
    </div>
  </div>
</div>

<script>
  // Initialize Tabulator
  document.addEventListener('DOMContentLoaded', function() {
    {% if flights %}
    const tableData = [
      {% for flight in flights %}
      {
        id: {{ loop.index }},
        flight: "{{ flight.source }} &rarr; {{ flight.dest }}",
        departure: "{{ flight.departure_time }}",
        status: "{{ flight.flight_status }}",
        statusClass: "{% if flight.flight_status == 'Active' %}badge-info{% elif flight.flight_status == 'Canceled' %}badge-danger{% elif flight.flight_status == 'Completed' %}badge-success{% elif flight.flight_status == 'Fully Booked' %}badge-warning{% else %}badge-secondary{% endif %}",
        canCancel: {{ 'true' if flight.can_cancel else 'false' }},
        sourceId: "{{ flight.source_airport_id }}",
        destId: "{{ flight.dest_airport_id }}",
        departureTime: "{{ flight.departure_time }}",
        source: "{{ flight.source }}",
        dest: "{{ flight.dest }}",
        cancelUrl: "{{ url_for('manager.cancel_flight_route', source_id=flight.source_airport_id, dest_id=flight.dest_airport_id, departure_time=flight.departure_time) }}",
        hoursUntilFlight: {{ flight.hours_until_flight if flight.hours_until_flight is defined else 0 }}
      }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    const table = new Tabulator("#flightsTable", {
      data: tableData,
      layout: "fitDataStretch",
      pagination: true,
      paginationSize: 10,
      paginationSizeSelector: [10, 25, 50, 100],
      columns: [
        {
          title: "Flight",
          field: "flight",
          formatter: "html",
          widthGrow: 2,
          minWidth: 200,
          cssClass: "tabulator-cell-wrap"
        },
        {
          title: "Departure",
          field: "departure",
          widthGrow: 1,
          minWidth: 150
        },
        {
          title: "Status",
          field: "status",
          widthGrow: 1,
          minWidth: 100,
          formatter: function(cell, formatterParams) {
            const status = cell.getValue();
            const statusClass = cell.getRow().getData().statusClass;
            return '<span class="badge ' + statusClass + '">' + status + '</span>';
          }
        },
        {
          title: "More Info",
          field: "moreInfo",
          widthGrow: 1,
          minWidth: 120,
          formatter: function(cell, formatterParams) {
            const rowData = cell.getRow().getData();
            const sourceId = rowData.sourceId;
            const destId = rowData.destId;
            const departureTime = rowData.departureTime;
            return '<button type="button" class="btn btn-sm more-info-btn" onclick="event.stopPropagation(); openFlightModal(\'' + sourceId + '\', \'' + destId + '\', \'' + departureTime + '\');">More Info</button>';
          }
        },
        {
          title: "Action",
          field: "action",
          widthGrow: 2,
          minWidth: 180,
          formatter: function(cell, formatterParams) {
            const rowData = cell.getRow().getData();
            if (rowData.canCancel) {
              return '<form class="cancel-flight-form" action="' + rowData.cancelUrl + '" method="POST" style="display: inline;"><button type="submit" class="btn btn--danger btn-sm">Cancel</button></form>';
            } else if (rowData.status === 'Canceled') {
              return '<span class="cancel-disabled">Already Canceled</span>';
            } else if (rowData.status === 'Completed') {
              return '<span class="cancel-disabled">Cannot Cancel (Completed)</span>';
            } else if (rowData.hoursUntilFlight > 0 && rowData.hoursUntilFlight < 72) {
              return '<span class="cancel-disabled">Cannot Cancel (< 72h)</span>';
            } else {
              return '<span class="cancel-disabled">Cannot Cancel</span>';
            }
          }
        }
      ],
      rowClick: function(e, row) {
        // Don't open modal if clicking on form or button
        const target = e.target || (e.originalEvent && e.originalEvent.target);
        if (target) {
          const clickedElement = target.tagName ? target : target.parentElement;
          if (clickedElement && (clickedElement.closest('form') || clickedElement.closest('button') || clickedElement.tagName === 'BUTTON' || clickedElement.tagName === 'FORM')) {
            return;
          }
        }
        const data = row.getData();
        if (data.sourceId && data.destId && data.departureTime) {
          openFlightModal(data.sourceId, data.destId, data.departureTime);
        }
      }
    });

    // Handle cancel form submissions
    document.addEventListener('submit', function(e) {
      if (e.target.classList.contains('cancel-flight-form')) {
        e.preventDefault();
        e.stopPropagation();
        const form = e.target;
        const row = table.getRows().find(r => {
          const rowElement = r.getElement();
          return rowElement.contains(form);
        });
        if (row) {
          const data = row.getData();
          showCancelConfirmation(form.id || 'cancel-form', data.source, data.dest, form);
        }
      }
    });
    {% endif %}
  });

  function openFlightModal(sourceId, destId, departureTime) {
    document.getElementById("flightModal").style.display = "block";
    document.getElementById("loadingMessage").style.display = "block";
    document.getElementById("flightContent").style.display = "none";

    fetch(`/api/flight_details/${sourceId}/${destId}/${departureTime}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          document.getElementById("loadingMessage").innerText = data.error;
          return;
        }

        let crewHtml = '<ul style="padding-left: 20px; margin: 5px 0;">';
        if (data.crew && data.crew.length > 0) {
          data.crew.forEach((member) => {
            const badge = member.is_pilot
              ? '<span class="pilot-badge">Pilot</span>'
              : '<span class="attendant-badge">Attendant</span>';
            crewHtml += `<li>${member.first_name} ${member.last_name} ${badge}</li>`;
          });
        } else {
          crewHtml += '<li style="color: #999;">No crew assigned</li>';
        }
        crewHtml += "</ul>";

        const aircraftInfo = data.manufacturer
          ? `${data.manufacturer} (ID: ${data.aircraft_id}) ${
              data.is_large ? '<span class="badge badge-info">Large</span>' : ""
            }`
          : "Not Assigned";

        const html = `
                <div class="detail-row">
                    <span class="detail-label">Route</span>
                    <span class="detail-value">${data.source} &rarr; ${
          data.dest
        }</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Departure</span>
                    <span class="detail-value">${data.departure_time}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Aircraft</span>
                    <span class="detail-value">${aircraftInfo}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Pricing</span>
                    <div class="detail-value" style="text-align: right;">
                        <div>Economy: $${data.economy_price}</div>
                        <div>Business: $${data.business_price}</div>
                    </div>
                </div>
                <div class="detail-row" style="display: block;">
                    <div class="detail-label" style="margin-bottom: 5px;">Assigned Crew</div>
                    ${crewHtml}
                </div>
            `;

        document.getElementById("flightContent").innerHTML = html;
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("flightContent").style.display = "block";
      })
      .catch((err) => {
        console.error(err);
        document.getElementById("loadingMessage").innerText =
          "Error loading details.";
        if (window.popupManager) {
          window.popupManager.error("Error loading flight details.");
        }
      });
  }

  function closeModal() {
    document.getElementById("flightModal").style.display = "none";
  }


  // Close modal when clicking outside
  window.onclick = function (event) {
    if (event.target == document.getElementById("flightModal")) {
      closeModal();
    }
  };

  // Confirmation dialog for flight cancellation
  function showCancelConfirmation(formId, source, dest, formElement) {
    if (!window.popupManager) {
      // Fallback to browser confirm if popupManager not available
      if (confirm(`Are you sure you want to cancel this flight?\n\nRoute: ${source} → ${dest}`)) {
        document.getElementById(formId).submit();
      }
      return;
    }

    // Create a custom confirmation dialog
    const confirmationDiv = document.createElement('div');
    confirmationDiv.className = 'confirmation-dialog';
    confirmationDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      z-index: 10001;
      max-width: 400px;
      width: 90%;
    `;
    
    confirmationDiv.innerHTML = `
      <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--color-text);">Confirm Cancellation</h3>
      <p style="margin-bottom: 1.5rem; color: var(--color-text-light);">
        Are you sure you want to cancel this flight?<br><br>
        <strong>Route:</strong> ${source} → ${dest}
      </p>
      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button id="confirm-cancel-no" class="btn btn--secondary" style="min-width: 100px;">No</button>
        <button id="confirm-cancel-yes" class="btn btn--danger" style="min-width: 100px;">Yes, Cancel</button>
      </div>
    `;

    // Create overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
    `;

    document.body.appendChild(overlay);
    document.body.appendChild(confirmationDiv);

    // Handle Yes button
    document.getElementById('confirm-cancel-yes').addEventListener('click', () => {
      document.body.removeChild(overlay);
      document.body.removeChild(confirmationDiv);
      if (formElement) {
        formElement.submit();
      } else if (formId) {
        document.getElementById(formId).submit();
      }
    });

    // Handle No button
    document.getElementById('confirm-cancel-no').addEventListener('click', () => {
      document.body.removeChild(overlay);
      document.body.removeChild(confirmationDiv);
    });

    // Close on overlay click
    overlay.addEventListener('click', () => {
      document.body.removeChild(overlay);
      document.body.removeChild(confirmationDiv);
    });
  }
</script>
{% endblock %}
