{% extends 'layout/base.html' %}

{% block content %}
<div class="container">
  <h2>Manage Flights</h2>
  
  <form method="GET" action="{{ url_for('manager.manage_flights') }}" class="filter-form">
      <div class="filter-group">
          <label>Status</label>
          <select name="status" class="filter-control">
              <option value="">All</option>
              <option value="Active" {% if request.args.get('status') == 'Active' %}selected{% endif %}>Active</option>
              <option value="Delayed" {% if request.args.get('status') == 'Delayed' %}selected{% endif %}>Delayed</option>
              <option value="Cancelled" {% if request.args.get('status') == 'Cancelled' %}selected{% endif %}>Cancelled</option>
              <option value="Landed" {% if request.args.get('status') == 'Landed' %}selected{% endif %}>Landed</option>
          </select>
      </div>
      <div class="filter-group">
          <label>Source</label>
          <select name="source_id" class="filter-control">
              <option value="">All</option>
              {% for airport in airports %}
              <option value="{{ airport.airport_id }}" {% if request.args.get('source_id')|int == airport.airport_id %}selected{% endif %}>{{ airport.airport_name }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="filter-group">
          <label>Destination</label>
          <select name="dest_id" class="filter-control">
              <option value="">All</option>
              {% for airport in airports %}
              <option value="{{ airport.airport_id }}" {% if request.args.get('dest_id')|int == airport.airport_id %}selected{% endif %}>{{ airport.airport_name }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="filter-group">
          <label>From Date</label>
          <input type="date" name="date_from" class="filter-control" value="{{ request.args.get('date_from', '') }}">
      </div>
      <div class="filter-group">
          <label>To Date</label>
          <input type="date" name="date_to" class="filter-control" value="{{ request.args.get('date_to', '') }}">
      </div>
      <div class="filter-actions">
          <button type="submit" class="btn">Filter</button>
          <a href="{{ url_for('manager.manage_flights') }}" class="btn btn-secondary">Clear</a>
      </div>
  </form>

  <div class="card table-card">
    <div class="table-wrapper">
      <table class="table">

      <thead>
        <tr>
          <th>Flight</th>
          <th>Departure</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for flight in flights %}
        <tr onclick="openFlightModal('{{ flight.source_airport_id }}', '{{ flight.dest_airport_id }}', '{{ flight.departure_time }}')" class="clickable-row">
          <td class="flight-route">
              {{ flight.source }} &rarr; {{ flight.dest }}
          </td>
          <td>{{ flight.departure_time }}</td>
          <td>
              <span class="badge {% if flight.flight_status == 'Active' %}badge-info{% elif flight.flight_status == 'Cancelled' %}badge-danger{% else %}badge-secondary{% endif %}">
                  {{ flight.flight_status }}
              </span>
          </td>
          <td>
            {% if flight.can_cancel %}
            <a
              href="{{ url_for('manager.cancel_flight_route', source_id=flight.source_airport_id, dest_id=flight.dest_airport_id, departure_time=flight.departure_time) }}"
              class="btn-cancel"
              onclick="event.stopPropagation(); return confirm('Are you sure you want to cancel this flight?');"
            >
              Cancel
            </a>
            {% else %}
            <span class="cancel-disabled">Cannot Cancel (< 72h)</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="empty-state">
            <div style="text-align: center; padding: 3rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">âœˆ</div>
              <p style="font-size: 1.1rem; color: var(--color-text-light); margin-bottom: 0.5rem;"><strong>No flights found</strong></p>
              <p style="color: var(--color-text-light);">No flights match your filters. Try <a href="{{ url_for('manager.manage_flights') }}" style="color: var(--color-primary); text-decoration: underline;">clearing filters</a> or <a href="{{ url_for('manager.add_flight') }}" style="color: var(--color-primary); text-decoration: underline;">add a new flight</a>.</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
  <div class="back-link-container">
    <a
      href="{{ url_for('manager.manager_dashboard') }}"
      class="btn btn-secondary"
      >Back to Dashboard</a
    >
  </div>
</div>

<!-- The Modal -->
<div id="flightModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
        <h3>Flight Details</h3>
        <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body">
        <div id="loadingMessage">Loading details...</div>
        <div id="flightContent" style="display: none">
            <!-- Content will be injected here -->
        </div>
    </div>
  </div>
</div>

<script>
  function openFlightModal(sourceId, destId, departureTime) {
    document.getElementById("flightModal").style.display = "block";
    document.getElementById("loadingMessage").style.display = "block";
    document.getElementById("flightContent").style.display = "none";

    fetch(`/api/flight_details/${sourceId}/${destId}/${departureTime}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          document.getElementById("loadingMessage").innerText = data.error;
          return;
        }

        let crewHtml = '<ul style="padding-left: 20px; margin: 5px 0;">';
        if (data.crew && data.crew.length > 0) {
          data.crew.forEach((member) => {
            const badge = member.is_pilot
              ? '<span class="pilot-badge">Pilot</span>'
              : '<span class="attendant-badge">Attendant</span>';
            crewHtml += `<li>${member.first_name} ${member.last_name} ${badge}</li>`;
          });
        } else {
          crewHtml += '<li style="color: #999;">No crew assigned</li>';
        }
        crewHtml += "</ul>";

        const aircraftInfo = data.manufacturer
          ? `${data.manufacturer} (ID: ${data.aircraft_id}) ${
              data.is_large ? '<span class="badge badge-info">Large</span>' : ""
            }`
          : "Not Assigned";

        const html = `
                <div class="detail-row">
                    <span class="detail-label">Route</span>
                    <span class="detail-value">${data.source} &rarr; ${
          data.dest
        }</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Departure</span>
                    <span class="detail-value">${data.departure_time}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Aircraft</span>
                    <span class="detail-value">${aircraftInfo}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Pricing</span>
                    <div class="detail-value" style="text-align: right;">
                        <div>Economy: $${data.economy_price}</div>
                        <div>Business: $${data.business_price}</div>
                    </div>
                </div>
                <div class="detail-row" style="display: block;">
                    <div class="detail-label" style="margin-bottom: 5px;">Assigned Crew</div>
                    ${crewHtml}
                </div>
                
                <div class="status-update-section">
                    <h4>Update Status</h4>
                    <div class="status-controls">
                        <select id="newStatus" class="status-select">
                            <option value="Active" ${
                              data.flight_status === "Active" ? "selected" : ""
                            }>Active</option>
                            <option value="Delayed" ${
                              data.flight_status === "Delayed" ? "selected" : ""
                            }>Delayed</option>
                            <option value="Cancelled" ${
                              data.flight_status === "Cancelled"
                                ? "selected"
                                : ""
                            }>Cancelled</option>
                            <option value="Landed" ${
                              data.flight_status === "Landed" ? "selected" : ""
                            }>Landed</option>
                        </select>
                        <button onclick="updateStatus(${
                          data.source_airport_id
                        }, ${data.dest_airport_id}, '${
          data.departure_time
        }')" class="btn-update">Update Status</button>
                    </div>
                </div>
            `;

        document.getElementById("flightContent").innerHTML = html;
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("flightContent").style.display = "block";
      })
      .catch((err) => {
        console.error(err);
        document.getElementById("loadingMessage").innerText =
          "Error loading details.";
        if (window.popupManager) {
          window.popupManager.error("Error loading flight details.");
        }
      });
  }

  function closeModal() {
    document.getElementById("flightModal").style.display = "none";
  }

  function updateStatus(sourceId, destId, departureTime) {
    const newStatus = document.getElementById("newStatus").value;

    fetch("/update_flight_status", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        source_id: sourceId,
        dest_id: destId,
        departure_time: departureTime,
        status: newStatus,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Persist the success message across reload (popups are non-blocking).
          window.popupManager.queueForNextLoad("Status updated successfully!", "success");
          location.reload(); // Reload to reflect changes in the table
        } else {
          window.popupManager.error("Error updating status: " + data.message);
        }
      })
      .catch((err) => {
        console.error(err);
        window.popupManager.error("Error updating status.");
      });
  }

  // Close modal when clicking outside
  window.onclick = function (event) {
    if (event.target == document.getElementById("flightModal")) {
      closeModal();
    }
  };
</script>
{% endblock %}
